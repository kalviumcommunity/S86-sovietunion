// Firestore security rules for the Soviet Union app
// - Block anonymous writes
// - Allow users to read/write only their own user document
// - Allow task creation by authenticated users and updates only by owner or admin
// - Restrict admin-only operations to users with custom claim `admin` == true

service cloud.firestore {
  match /databases/{database}/documents {

    // Users collection: each user can read/write only their own document
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Tasks collection: authenticated users can create tasks where owner == auth.uid
    // Only the owner or an admin (custom claim) can update/delete a task
    match /tasks/{taskId} {
      allow create: if request.auth != null
                    && request.resource.data.owner == request.auth.uid;

      allow read: if request.auth != null && (
          resource.data.owner == request.auth.uid ||
          request.auth.token.admin == true
      );

      allow update, delete: if request.auth != null && (
          resource.data.owner == request.auth.uid ||
          request.auth.token.admin == true
      );
    }

    // Admin-only operations on a special collection
    match /admin/{doc=**} {
      allow read, write: if request.auth != null && request.auth.token.admin == true;
    }

    // Deny everything else by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
